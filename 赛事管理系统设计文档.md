# 赛事管理系统设计文档

> 基于现有用户认证系统的赛车模拟器赛事管理功能扩展

## 一、系统概述

本系统在现有的用户认证和权限管理基础上,扩展赛事管理功能。支持主办方创建赛事、参赛者报名参赛、管理员审核赛事的完整流程。

### 1.1 角色定义

系统包含三种角色:

| 角色 | 角色标识 | 主要功能 |
|------|---------|---------|
| 管理员 | ADMIN | 审核赛事、处理违规、系统管理 |
| 主办方 | ORGANIZER | 创建赛事、审核报名、管理参赛名单 |
| 参赛者 | USER | 浏览赛事、报名参赛、查看报名状态 |

### 1.2 核心功能

- 赛事发布与管理
- 参赛报名与审核
- 赛事信息展示
- 报名状态查询

---

## 二、数据库设计

### 2.1 赛事信息表 (settings_match)

存储赛事的基本信息和配置。

```sql
CREATE TABLE settings_match (
    match_uuid VARCHAR(36) PRIMARY KEY,          -- 赛事唯一标识
    organizer_uuid VARCHAR(36) NOT NULL,         -- 主办方UUID(关联settings_user)
    match_name VARCHAR(100) NOT NULL,            -- 赛事名称
    match_description TEXT,                      -- 赛事介绍
    game_uuid VARCHAR(36) NOT NULL,              -- 游戏UUID(关联settings_game)
    track_uuid VARCHAR(36),                      -- 赛道UUID(关联settings_track)
    registration_start_time TIMESTAMP NOT NULL,  -- 报名开始时间
    registration_end_time TIMESTAMP NOT NULL,    -- 报名结束时间
    match_start_time TIMESTAMP NOT NULL,         -- 赛事开始时间
    max_participants INT DEFAULT 50,             -- 最大参赛人数
    current_participants INT DEFAULT 0,          -- 当前报名人数
    match_status VARCHAR(20) DEFAULT 'PENDING',  -- 赛事状态
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**赛事状态说明**:
- `PENDING`: 待审核(主办方创建后)
- `APPROVED`: 审核通过(管理员审核通过,可接受报名)
- `REJECTED`: 审核拒绝
- `ONGOING`: 进行中
- `FINISHED`: 已结束
- `CANCELLED`: 已取消

### 2.2 报名记录表 (settings_match_registration)

存储参赛者的报名信息和审核状态。

```sql
CREATE TABLE settings_match_registration (
    registration_uuid VARCHAR(36) PRIMARY KEY,   -- 报名记录唯一标识
    match_uuid VARCHAR(36) NOT NULL,             -- 赛事UUID
    user_uuid VARCHAR(36) NOT NULL,              -- 参赛者UUID
    registration_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP, -- 报名时间
    registration_status VARCHAR(20) DEFAULT 'PENDING',     -- 报名状态
    contact_info VARCHAR(200),                   -- 联系方式
    remarks TEXT,                                -- 备注信息
    review_time TIMESTAMP,                       -- 审核时间
    review_reason VARCHAR(500),                  -- 审核说明
    FOREIGN KEY (match_uuid) REFERENCES settings_match(match_uuid),
    FOREIGN KEY (user_uuid) REFERENCES settings_user(user_uuid),
    UNIQUE (match_uuid, user_uuid)               -- 同一用户不能重复报名同一赛事
);
```

**报名状态说明**:
- `PENDING`: 待审核(参赛者提交报名后)
- `APPROVED`: 审核通过(主办方审核通过)
- `REJECTED`: 审核拒绝
- `CANCELLED`: 已取消(参赛者主动取消)

---

## 三、API接口设计

### 3.1 主办方接口 (需要ORGANIZER或ADMIN角色)

#### 创建赛事
```
POST /v1/match/create
```

**请求参数 (CreateMatchVO)**:
```json
{
  "matchName": "ACC冠军赛第一赛季",
  "matchDescription": "面向高水平车手的竞技赛事",
  "gameUuid": "游戏UUID",
  "trackUuid": "赛道UUID",
  "registrationStartTime": "2025-10-20T00:00:00",
  "registrationEndTime": "2025-10-25T23:59:59",
  "matchStartTime": "2025-10-27T14:00:00",
  "maxParticipants": 30
}
```

#### 更新赛事信息
```
PUT /v1/match/update
```

#### 查看本人创建的赛事列表
```
GET /v1/match/myMatches
```

#### 审核报名
```
POST /v1/match/reviewRegistration
```

**请求参数**:
```json
{
  "registrationUuid": "报名记录UUID",
  "status": "APPROVED",  // 或 "REJECTED"
  "reviewReason": "审核说明"
}
```

### 3.2 参赛者接口 (需要登录)

#### 浏览赛事列表
```
GET /v1/match/list?page=1&size=10&status=APPROVED
```

#### 查看赛事详情
```
GET /v1/match/detail/{matchUuid}
```

#### 报名参赛
```
POST /v1/match/register
```

**请求参数 (RegisterMatchVO)**:
```json
{
  "matchUuid": "赛事UUID",
  "contactInfo": "QQ: 123456789",
  "remarks": "有3年ACC比赛经验"
}
```

#### 查看我的报名记录
```
GET /v1/match/myRegistrations
```

#### 取消报名
```
POST /v1/match/cancelRegistration/{registrationUuid}
```

### 3.3 管理员接口 (需要ADMIN角色)

#### 审核赛事
```
POST /v1/match/reviewMatch
```

**请求参数**:
```json
{
  "matchUuid": "赛事UUID",
  "status": "APPROVED",  // 或 "REJECTED"
  "reviewReason": "审核说明"
}
```

#### 查看待审核赛事列表
```
GET /v1/match/pendingMatches
```

---

## 四、业务流程

### 4.1 赛事创建流程

```
主办方 → 填写赛事信息 → 提交创建 → 状态: PENDING
       ↓
管理员 → 审核赛事 → 通过 → 状态: APPROVED (可接受报名)
                  → 拒绝 → 状态: REJECTED
```

### 4.2 报名审核流程

```
参赛者 → 选择赛事 → 提交报名 → 状态: PENDING
       ↓
主办方 → 查看报名列表 → 审核 → 通过 → 状态: APPROVED
                           → 拒绝 → 状态: REJECTED
```

### 4.3 赛事状态流转

```
PENDING (待审核)
   ↓ (管理员审核通过)
APPROVED (审核通过/报名中)
   ↓ (到达比赛开始时间)
ONGOING (进行中)
   ↓ (比赛结束)
FINISHED (已结束)

任何状态都可以 → CANCELLED (取消)
```

---

## 五、数据模型 (Java实体类)

### 5.1 赛事实体 (SettingsMatchDO)

```java
@Data
@TableName("settings_match")
public class SettingsMatchDO {
    @TableId(type = IdType.NONE)
    private String matchUuid;
    private String organizerUuid;
    private String matchName;
    private String matchDescription;
    private String gameUuid;
    private String trackUuid;
    private LocalDateTime registrationStartTime;
    private LocalDateTime registrationEndTime;
    private LocalDateTime matchStartTime;
    private Integer maxParticipants;
    private Integer currentParticipants;
    private String matchStatus;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

### 5.2 报名记录实体 (SettingsMatchRegistrationDO)

```java
@Data
@TableName("settings_match_registration")
public class SettingsMatchRegistrationDO {
    @TableId(type = IdType.NONE)
    private String registrationUuid;
    private String matchUuid;
    private String userUuid;
    private LocalDateTime registrationTime;
    private String registrationStatus;
    private String contactInfo;
    private String remarks;
    private LocalDateTime reviewTime;
    private String reviewReason;
}
```

---

## 六、开发任务清单

### 阶段一: 数据库和基础实体

- [ ] 创建 `settings_match.sql` 和 `settings_match_registration.sql`
- [ ] 创建实体类 `SettingsMatchDO` 和 `SettingsMatchRegistrationDO`
- [ ] 创建 Mapper 接口 `SettingsMatchMapper` 和 `SettingsMatchRegistrationMapper`
- [ ] 创建 DAO 类 `SettingsMatchDAO` 和 `SettingsMatchRegistrationDAO`

### 阶段二: 业务逻辑层

- [ ] 创建 `MatchService` 接口,定义业务方法
- [ ] 创建 `MatchLogic` 类,实现业务逻辑
- [ ] 实现赛事创建、更新、查询功能
- [ ] 实现报名、审核功能

### 阶段三: 控制器层

- [ ] 创建 `MatchController` 控制器
- [ ] 实现主办方相关接口
- [ ] 实现参赛者相关接口
- [ ] 实现管理员相关接口

### 阶段四: 测试与优化

- [ ] 编写单元测试
- [ ] 测试完整业务流程
- [ ] 优化查询性能
- [ ] 完善异常处理

---

## 七、注意事项

### 7.1 权限控制

- 使用现有的 JWT 认证机制
- 创建赛事需要验证用户角色为 ORGANIZER 或 ADMIN
- 审核报名只能由赛事创建者或管理员操作
- 参赛者只能报名状态为 APPROVED 的赛事

### 7.2 数据验证

- 报名时间必须在赛事报名时间范围内
- 报名人数不能超过最大参赛人数
- 同一用户不能重复报名同一赛事
- 赛事开始时间必须晚于报名结束时间

### 7.3 业务规则

- 赛事创建后状态为 PENDING,需要管理员审核
- 只有 APPROVED 状态的赛事才能接受报名
- 报名截止后不能再报名
- 主办方可以在报名期间修改赛事信息

---

## 八、扩展功能(可选)

如果时间充裕,可以考虑以下扩展功能:

1. **赛事分类**: 按游戏类型、难度级别分类
2. **报名统计**: 报名人数趋势、参赛者分布
3. **赛事通知**: 报名审核结果邮件通知
4. **赛程管理**: 多轮次、淘汰赛、积分赛
5. **成绩记录**: 记录比赛成绩和排名

---

## 附录: 快速开发命令

```bash
# 编译项目
./mvnw clean compile

# 运行项目
./mvnw spring-boot:run

# 运行测试
./mvnw test

# 打包项目
./mvnw clean package
```

---

**文档版本**: v1.0
**最后更新**: 2025-10-12
